<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE公式・Lステップ費用シミュレーター</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #06C755;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==========================================
        // 設定: ここにGASのウェブアプリURLを貼り付けます
        // 空の場合は、下部のDEFAULT_DATAが使用されます
        // ==========================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbztV0zmVI8ms7ZP5gAjqm9fd3H0ty7xC7ELGm-Rs6G_2VepZLWlqlFJWt8Y0v0j9xc4/exec"; 

        // デフォルトデータ（CSVから抽出した構造）
        const DEFAULT_DATA = {
            // Lステップ制作・構築費用の項目
            initialItems: [
                { id: '0-a', name: '進行管理費', price: 50000, category: 'base', required: true },
                { id: '1-a', name: '要件整理', price: 50000, category: 'base', required: true },
                { id: '1-b', name: 'LINE公式アカウント基本構築', price: 10000, category: 'setup', required: false },
                { id: '1-c', name: 'LINE公式・Lステップ連携', price: 5000, category: 'setup', required: true },
                { id: '2-a', name: 'あいさつメッセージ作成', price: 10000, category: 'content', required: false },
                { id: '2-b', name: 'ステップ配信作成(5日分)', price: 50000, category: 'content', required: false },
                { id: '2-c', name: 'リッチメニュー作成', price: 20000, category: 'design', required: false },
                { id: '6-f', name: 'サイト連携', price: 50000, category: 'advanced', required: false },
            ],
            // 月次運用のオプション
            monthlyOptions: [
                { id: '1-a', name: 'LINE公式アカウント修正・管理', price: 5000, type: 'line_opt' },
                { id: '1-b', name: '月1回コンサルティング(LINE)', price: 50000, type: 'line_opt' },
                { id: '2-a', name: 'Lステップ修正・管理', price: 10000, type: 'lstep_opt' },
                { id: '2-c', name: 'Lステップ配信代行(フル)', price: 250000, type: 'lstep_opt' },
            ],
            // 友だち数によるサポート費用（参照CSVより）
            supportTiers: [
                { max: 499, price: 10000 },
                { max: 999, price: 15000 },
                { max: 2999, price: 20000 },
                { max: 4999, price: 25000 },
                { max: 7499, price: 30000 },
                { max: 9999, price: 35000 },
                { max: 14999, price: 40000 },
                { max: 1000000, price: 50000 } // 上限設定
            ]
        };

        const App = () => {
            // 状態管理
            const [friends, setFriends] = useState(500);
            const [broadcasts, setBroadcasts] = useState(4); // 月の配信回数
            const [data, setData] = useState(DEFAULT_DATA);
            const [loading, setLoading] = useState(false);
            const [selectedInitialItems, setSelectedInitialItems] = useState({});
            const [selectedMonthlyOptions, setSelectedMonthlyOptions] = useState({});

            // データ取得 (GAS連携用)
            useEffect(() => {
                if (!GAS_API_URL) {
                    // 必須項目を初期選択
                    const defaults = {};
                    DEFAULT_DATA.initialItems.forEach(item => {
                        if (item.required) defaults[item.id] = true;
                    });
                    setSelectedInitialItems(defaults);
                    return;
                }

                setLoading(true);
                fetch(GAS_API_URL)
                    .then(res => res.json())
                    .then(fetchedData => {
                        setData(fetchedData);
                        // 必須項目の初期化
                        const defaults = {};
                        fetchedData.initialItems.forEach(item => {
                            if (item.required) defaults[item.id] = true;
                        });
                        setSelectedInitialItems(defaults);
                    })
                    .catch(err => {
                        console.error("Data fetch error, using default:", err);
                        const defaults = {};
                        DEFAULT_DATA.initialItems.forEach(item => {
                            if (item.required) defaults[item.id] = true;
                        });
                        setSelectedInitialItems(defaults);
                    })
                    .finally(() => setLoading(false));
            }, []);

            // === 計算ロジック ===

            // 1. 推定配信通数
            const estimatedMessages = friends * broadcasts;

            // 2. LINE公式アカウント費用計算 (2025年基準)
            // コミュニケーション: 0円 (200通まで)
            // ライト: 5,000円 (5,000通まで)
            // スタンダード: 15,000円 (30,000通まで, 以降従量課金~3円)
            const lineOfficialCost = useMemo(() => {
                if (estimatedMessages <= 200) return { plan: 'コミュニケーション', cost: 0 };
                if (estimatedMessages <= 5000) return { plan: 'ライト', cost: 5000 };
                
                let cost = 15000;
                if (estimatedMessages > 30000) {
                    // 30,000通超えは従量課金（最大3円で概算）
                    cost += (estimatedMessages - 30000) * 3;
                }
                return { plan: 'スタンダード', cost: cost };
            }, [estimatedMessages]);

            // 3. Lステップ費用計算
            // スタート: 2,980円 (1,000通)
            // スタンダード: 21,780円 (15,000通)
            // プロ: 32,780円 (45,000通)
            // 大量送信: 45,000通以上の場合のオプションや上位プラン
            const lStepCost = useMemo(() => {
                // 通数だけでなく、友だち登録数による制限もありますが、ここでは配信数を主軸に簡易シミュレーション
                if (estimatedMessages <= 1000) return { plan: 'スタート', cost: 2980 };
                if (estimatedMessages <= 15000) return { plan: 'スタンダード', cost: 21780 };
                if (estimatedMessages <= 45000) return { plan: 'プロ', cost: 32780 };
                
                // 大量送信プラン (45,000通以上)
                // 実際はプロプラン＋大量送信オプション(10万通まで+2万円など)
                // 概算としてプロプラン + 大量送信OP(例: +20,000円〜)
                return { plan: 'プロ＋大量送信OP', cost: 32780 + 22000 }; 
            }, [estimatedMessages]);

            // 4. 自社サポート費用 (友だち数連動)
            const supportCost = useMemo(() => {
                const tier = data.supportTiers.find(t => friends <= t.max) || data.supportTiers[data.supportTiers.length - 1];
                return tier.price;
            }, [friends, data]);

            // 5. 選択オプション費用計算
            const initialTotal = Object.keys(selectedInitialItems).reduce((sum, id) => {
                if (!selectedInitialItems[id]) return sum;
                const item = data.initialItems.find(i => i.id === id);
                return sum + (item ? item.price : 0);
            }, 0);

            const monthlyOptionTotal = Object.keys(selectedMonthlyOptions).reduce((sum, id) => {
                if (!selectedMonthlyOptions[id]) return sum;
                const item = data.monthlyOptions.find(i => i.id === id);
                return sum + (item ? item.price : 0);
            }, 0);

            // 合計
            const totalMonthly = lineOfficialCost.cost + lStepCost.cost + supportCost + monthlyOptionTotal;

            // 数値フォーマット
            const fmt = (num) => num.toLocaleString();

            return (
                <div className="max-w-5xl mx-auto p-4 md:p-8">
                    <header className="text-center mb-10">
                        <h1 className="text-3xl font-bold text-[#06C755] mb-2">LINE公式・Lステップ費用シミュレーター</h1>
                        <p className="text-gray-600">運用規模に合わせて最適なプランと概算費用を算出します</p>
                    </header>

                    <div className="grid md:grid-cols-12 gap-8">
                        {/* 左カラム: 入力エリア */}
                        <div className="md:col-span-7 space-y-8">
                            
                            {/* スライダーセクション */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                <h2 className="text-xl font-bold mb-6 flex items-center">
                                    <span className="bg-[#06C755] w-2 h-6 mr-3 rounded-full"></span>
                                    運用規模の設定
                                </h2>
                                
                                <div className="mb-8">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">想定友だち登録数</label>
                                    <div className="flex items-center gap-4">
                                        <input 
                                            type="range" min="0" max="20000" step="100" 
                                            value={friends} 
                                            onChange={(e) => setFriends(Number(e.target.value))}
                                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#06C755]"
                                        />
                                        <div className="w-32 text-right font-bold text-2xl text-[#06C755]">
                                            {fmt(friends)}<span className="text-sm text-gray-500 ml-1">人</span>
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-400 mt-1">※友だち数が料金プランの基準になります</p>
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">月間配信回数（全体配信）</label>
                                    <div className="flex items-center gap-4">
                                        <input 
                                            type="range" min="0" max="20" step="1" 
                                            value={broadcasts} 
                                            onChange={(e) => setBroadcasts(Number(e.target.value))}
                                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#06C755]"
                                        />
                                        <div className="w-32 text-right font-bold text-2xl text-[#06C755]">
                                            {broadcasts}<span className="text-sm text-gray-500 ml-1">回/月</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gray-50 p-4 rounded-lg flex justify-between items-center">
                                    <span className="text-sm text-gray-600">月間推定配信通数</span>
                                    <span className="font-bold text-lg">{fmt(estimatedMessages)} 通</span>
                                </div>
                            </div>

                            {/* 構築オプション選択 */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                <h2 className="text-xl font-bold mb-6 flex items-center">
                                    <span className="bg-blue-500 w-2 h-6 mr-3 rounded-full"></span>
                                    初期構築オプション
                                </h2>
                                <div className="space-y-3">
                                    {data.initialItems.map(item => (
                                        <label key={item.id} className="flex items-start p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors border border-transparent hover:border-gray-200">
                                            <input 
                                                type="checkbox" 
                                                checked={!!selectedInitialItems[item.id]} 
                                                onChange={() => {
                                                    // 必須項目は解除できないようにする場合
                                                    if(item.required) return;
                                                    setSelectedInitialItems(prev => ({
                                                        ...prev,
                                                        [item.id]: !prev[item.id]
                                                    }))
                                                }}
                                                disabled={item.required}
                                                className="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                                            />
                                            <div className="ml-3 flex-1">
                                                <div className="flex justify-between">
                                                    <span className={`font-medium ${item.required ? 'text-gray-900' : 'text-gray-700'}`}>
                                                        {item.name} {item.required && <span className="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded ml-2">必須</span>}
                                                    </span>
                                                    <span className="text-gray-900">¥{fmt(item.price)}</span>
                                                </div>
                                            </div>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            {/* 月額運用オプション選択 */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                <h2 className="text-xl font-bold mb-6 flex items-center">
                                    <span className="bg-orange-400 w-2 h-6 mr-3 rounded-full"></span>
                                    月額運用オプション
                                </h2>
                                <div className="space-y-3">
                                    {data.monthlyOptions.map(item => (
                                        <label key={item.id} className="flex items-start p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors border border-transparent hover:border-gray-200">
                                            <input 
                                                type="checkbox" 
                                                checked={!!selectedMonthlyOptions[item.id]} 
                                                onChange={() => setSelectedMonthlyOptions(prev => ({
                                                    ...prev,
                                                    [item.id]: !prev[item.id]
                                                }))}
                                                className="mt-1 w-5 h-5 text-orange-500 rounded focus:ring-orange-400"
                                            />
                                            <div className="ml-3 flex-1">
                                                <div className="flex justify-between">
                                                    <span className="font-medium text-gray-700">{item.name}</span>
                                                    <span className="text-gray-900">¥{fmt(item.price)}/月</span>
                                                </div>
                                            </div>
                                        </label>
                                    ))}
                                </div>
                            </div>

                        </div>

                        {/* 右カラム: 見積もり結果（追従） */}
                        <div className="md:col-span-5">
                            <div className="sticky top-6 space-y-6">
                                
                                {/* 1. 初期費用カード */}
                                <div className="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                                    <div className="bg-gray-800 text-white p-4">
                                        <h3 className="font-bold text-lg text-center">初期構築費用（概算）</h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="flex justify-between items-end mb-2">
                                            <span className="text-gray-500 text-sm">制作費合計</span>
                                            <span className="text-3xl font-bold text-gray-800">¥{fmt(initialTotal)}</span>
                                        </div>
                                        <div className="text-xs text-right text-gray-400">※税抜表示</div>
                                    </div>
                                </div>

                                {/* 2. 月額費用カード */}
                                <div className="bg-white rounded-xl shadow-lg overflow-hidden border-t-4 border-[#06C755]">
                                    <div className="bg-gray-50 p-4 border-b border-gray-100">
                                        <h3 className="font-bold text-lg text-center text-gray-800">月額ランニングコスト</h3>
                                    </div>
                                    <div className="p-6 space-y-4">
                                        {/* プラットフォーム費用 */}
                                        <div className="space-y-2 pb-4 border-b border-dashed border-gray-200">
                                            <div className="text-xs font-bold text-gray-400 uppercase tracking-wider">プラットフォーム費用</div>
                                            
                                            <div className="flex justify-between text-sm">
                                                <div>
                                                    <div className="font-medium text-gray-700">LINE公式アカウント</div>
                                                    <div className="text-xs text-[#06C755]">{lineOfficialCost.plan}</div>
                                                </div>
                                                <div className="font-bold">¥{fmt(lineOfficialCost.cost)}</div>
                                            </div>

                                            <div className="flex justify-between text-sm">
                                                <div>
                                                    <div className="font-medium text-gray-700">Lステップ</div>
                                                    <div className="text-xs text-blue-500">{lStepCost.plan}</div>
                                                </div>
                                                <div className="font-bold">¥{fmt(lStepCost.cost)}</div>
                                            </div>
                                        </div>

                                        {/* 運用サポート費用 */}
                                        <div className="space-y-2 pb-4 border-b border-dashed border-gray-200">
                                            <div className="text-xs font-bold text-gray-400 uppercase tracking-wider">運用・サポート</div>
                                            
                                            <div className="flex justify-between text-sm">
                                                <div>
                                                    <div className="font-medium text-gray-700">基本運用サポート</div>
                                                    <div className="text-xs text-gray-400">友だち数 {fmt(friends)}人規模</div>
                                                </div>
                                                <div className="font-bold">¥{fmt(supportCost)}</div>
                                            </div>

                                            {Object.keys(selectedMonthlyOptions).length > 0 && (
                                                <div className="flex justify-between text-sm">
                                                    <div className="font-medium text-gray-700">選択オプション計</div>
                                                    <div className="font-bold">¥{fmt(monthlyOptionTotal)}</div>
                                                </div>
                                            )}
                                        </div>

                                        {/* 合計 */}
                                        <div className="pt-2">
                                            <div className="flex justify-between items-end">
                                                <span className="font-bold text-gray-600">月額合計</span>
                                                <span className="text-4xl font-bold text-[#06C755]">¥{fmt(totalMonthly)}</span>
                                            </div>
                                            <div className="text-xs text-right text-gray-400 mt-1">※税抜 / 別途消費税</div>
                                        </div>
                                    </div>
                                    <div className="bg-gray-50 p-4 text-center">
                                        <button className="w-full bg-[#06C755] hover:bg-[#05b34c] text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">
                                            この内容で相談する
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
